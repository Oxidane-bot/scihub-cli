import sys
import types
from pathlib import Path

from scihub_cli.converters.pdf_to_md import MarkdownConvertOptions
from scihub_cli.converters.pymupdf4llm_converter import Pymupdf4llmConverter


def test_converter_retries_with_tables_disabled(monkeypatch, tmp_path: Path):
    calls: list[dict] = []

    def _to_markdown(doc, **kwargs):  # noqa: ARG001
        calls.append(kwargs)
        if kwargs.get("table_strategy", "lines_strict") == "":
            return "# Converted\n\nok\n"
        raise AttributeError("'NoneType' object has no attribute 'tables'")

    monkeypatch.setitem(sys.modules, "pymupdf4llm", types.SimpleNamespace(to_markdown=_to_markdown))

    converter = Pymupdf4llmConverter()
    pdf_path = tmp_path / "paper.pdf"
    pdf_path.write_bytes(b"%PDF-1.4\n%%EOF\n")
    md_path = tmp_path / "paper.md"

    ok, error = converter.convert(
        str(pdf_path),
        str(md_path),
        options=MarkdownConvertOptions(overwrite=True),
    )

    assert ok, error
    assert error is None
    assert md_path.exists()
    assert "Converted" in md_path.read_text(encoding="utf-8")
    assert len(calls) >= 2
    assert calls[1].get("table_strategy") == ""


def test_converter_falls_back_to_plain_text(monkeypatch, tmp_path: Path):
    def _always_fail(doc, **kwargs):  # noqa: ARG001
        raise RuntimeError("pymupdf4llm failed")

    class _FakePage:
        def __init__(self, text: str):
            self._text = text

        def get_text(self, mode: str):  # noqa: ARG002
            return self._text

    class _FakeDoc:
        def __iter__(self):
            return iter([_FakePage("hello from page 1"), _FakePage("")])

        def close(self):
            return None

    monkeypatch.setitem(
        sys.modules,
        "pymupdf4llm",
        types.SimpleNamespace(to_markdown=_always_fail),
    )
    monkeypatch.setitem(
        sys.modules,
        "pymupdf",
        types.SimpleNamespace(open=lambda path: _FakeDoc()),  # noqa: ARG005
    )

    converter = Pymupdf4llmConverter()
    pdf_path = tmp_path / "paper.pdf"
    pdf_path.write_bytes(b"%PDF-1.4\n%%EOF\n")
    md_path = tmp_path / "paper.md"

    ok, error = converter.convert(
        str(pdf_path),
        str(md_path),
        options=MarkdownConvertOptions(overwrite=True),
    )

    assert ok, error
    content = md_path.read_text(encoding="utf-8")
    assert "Fallback markdown generated by plain-text extraction" in content
    assert "## Page 1" in content
    assert "hello from page 1" in content
    assert "## Page 2" in content
